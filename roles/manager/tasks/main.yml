---
- name: install base packages
  apt: name={{ item }} state=latest
  with_items: 
    - postgresql
    - php5-fpm
    - php5-pgsql
    - nginx
    - redis-server
    - htop

- name: Synchronize nginx site configuration
  synchronize: src=config/nginx/sites-enabled/ dest=/etc/nginx/sites-enabled/
  notify: 
    - restart nginx

- name: Increase stock SHMMAX
  sysctl: name=kernel.shmmax value=8589934592 sysctl_set=yes

- name: Increase stock SHMALL
  sysctl: name=kernel.shmall value=2097152 sysctl_set=yes

- name: Synchronize PostgreSQL configuration
  synchronize: src=config/postgresql/ dest=/etc/postgresql/9.1/main/
  notify:
    - restart postgresql

- name: Synchronize manager's initscript
  synchronize: src=config/initscripts/smisc-manager dest=/etc/init.d/smisc-manager

- name: Synchronize monit scripts
  synchronize: src=config/monit/ dest=/etc/monit/conf.d/
  notify:
     - reload monit

- name: Deploy smisc code
  synchronize: src=src/ dest=/usr/local/src/smisc/
  notify: 
    - restart manager

- name: Deploy smisc configuration
  synchronize: src=../../common/files/config/smisc.ini dest=/usr/local/share/smisc.ini
  notify:
    - restart manager

- name: Core services are running
  service: name={{ item }} state=started
  with_items:
    - postgresql
    - nginx
    - php5-fpm
    - smisc-manager
